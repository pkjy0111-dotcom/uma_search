<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ïä§ÌÜ†Î¶¨ - Ïö∞ÎßàÎ¨¥Ïä§Î©î</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Malgun Gothic', sans-serif; 
            max-width: 700px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .nav-btns { display: flex; gap: 8px; }
        
        .back-btn, .copy-btn {
            display: inline-block;
            padding: 10px 18px;
            background: #666;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .back-btn:hover, .copy-btn:hover { background: #444; }
        .copy-btn { background: #4a90d9; }
        .copy-btn:hover { background: #357abd; }
        .copy-btn.copied { background: #4caf50; }
        
        .story-header {
            background: linear-gradient(135deg, #4a90d9, #357abd);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .story-header h2 { margin: 0 0 12px 0; }
        .story-meta { font-size: 14px; opacity: 0.9; }
        .story-meta div { margin: 4px 0; }
        .story-source {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
        }
        .subtype-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255,255,255,0.25);
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .dialogue {
            margin: 12px 0;
            padding: 16px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .speaker {
            font-weight: bold;
            color: #4a90d9;
            margin-bottom: 10px;
            font-size: 15px;
        }
        .text { line-height: 1.7; color: #333; }
        
        .choices {
            margin-top: 12px;
            padding: 12px;
            background: #fff8e1;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        .choices-title {
            font-size: 12px;
            color: #f57c00;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .choice-block {
            margin: 10px 0;
            padding: 12px;
            background: #fffde7;
            border-radius: 8px;
            border: 1px solid #ffe082;
        }
        .choice-text {
            font-weight: bold;
            color: #f57c00;
            padding-bottom: 8px;
            border-bottom: 1px dashed #ffe082;
            margin-bottom: 10px;
        }
        .choice-label {
            font-size: 11px;
            color: #888;
            margin-left: 8px;
        }
        .branch-dialogue {
            margin: 8px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }
        .branch-speaker {
            font-weight: bold;
            color: #ff8f00;
            margin-bottom: 6px;
            font-size: 13px;
        }
        .branch-text { line-height: 1.6; font-size: 14px; }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #888;
            font-size: 18px;
        }
        .error {
            text-align: center;
            padding: 60px;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="nav-btns">
            <a class="back-btn" href="javascript:history.back()">‚Üê Îí§Î°úÍ∞ÄÍ∏∞</a>
            <a class="back-btn" href="index.html">üè† Ìôà</a>
        </div>
        <button class="copy-btn" onclick="copyStoryText()">üìã Ï†ÑÏ≤¥ Î≥µÏÇ¨</button>
    </div>
    
    <div id="content">
        <div class="loading">Ïä§ÌÜ†Î¶¨ Î°úÎî© Ï§ë...</div>
    </div>

    <script>
        const TYPE_LABELS = {
            character: 'Ï∫êÎ¶≠ÌÑ∞ Ïä§ÌÜ†Î¶¨', career: 'Ïú°ÏÑ± Ïä§ÌÜ†Î¶¨', event: 'Ïù¥Î≤§Ìä∏ Ïä§ÌÜ†Î¶¨',
            card: 'Ïπ¥Îìú Ïä§ÌÜ†Î¶¨', main: 'Î©îÏù∏ Ïä§ÌÜ†Î¶¨', lobby: 'Î°úÎπÑ Ïä§ÌÜ†Î¶¨', other: 'Í∏∞ÌÉÄ'
        };
        const SUBTYPE_LABELS = { main: 'Î©îÏù∏', career: 'Ïª§Î¶¨Ïñ¥', random: 'ÎûúÎç§', outfit: 'ÏùòÏÉÅ' };
        
        let charMap = {};
        let storyMap = {};
        let storyTextData = null; // Î≥µÏÇ¨Ïö© ÌÖçÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        
        async function init() {
            const params = new URLSearchParams(location.search);
            const storyId = params.get('id');
            
            if (!storyId) {
                showError('Ïä§ÌÜ†Î¶¨ IDÍ∞Ä ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            try {
                const [charResp, mapResp] = await Promise.all([
                    fetch('char_map.json'),
                    fetch('story_map.json')
                ]);
                charMap = await charResp.json();
                storyMap = await mapResp.json();
                
                const storyResp = await fetch(`stories/story_${storyId}.json`);
                if (!storyResp.ok) throw new Error('Ïä§ÌÜ†Î¶¨Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
                const story = await storyResp.json();
                
                renderStory(storyId, story);
            } catch (e) {
                showError(e.message);
            }
        }
        
        function showError(msg) {
            document.getElementById('content').innerHTML = `<div class="error">‚ùå ${msg}</div>`;
        }
        
        function renderStory(storyId, story) {
            const info = storyMap[storyId] || {};
            const casts = (story.casts || [])
                .filter(c => c > 0)
                .map(c => charMap[c] || `ID:${c}`);
            
            const name = info.name || `Ïä§ÌÜ†Î¶¨ ${storyId}`;
            const type = info.type || 'other';
            const subtype = info.subtype || '';
            const source = info.source || '';
            
            document.title = `${name} - Ïö∞ÎßàÎ¨¥Ïä§Î©î`;
            
            let html = `
                <div class="story-header">
                    <h2>${name}${subtype ? `<span class="subtype-badge">${SUBTYPE_LABELS[subtype]}</span>` : ''}</h2>
                    <div class="story-meta">
                        <div>ÌÉÄÏûÖ: ${TYPE_LABELS[type] || type}</div>
                        <div>Îì±Ïû•: ${casts.length ? casts.join(', ') : 'ÏóÜÏùå'}</div>
                    </div>
                    ${source ? `<div class="story-source">üìÅ ${source}</div>` : ''}
                </div>
            `;
            
            const frames = story.frames || {};
            const skipFrames = new Set();
            
            // Î≥µÏÇ¨Ïö© ÌÖçÏä§Ìä∏ ÏÉùÏÑ± Î≥ÄÏàò
            let copyText = `${name}\n`;
            copyText += `ÌÉÄÏûÖ: ${TYPE_LABELS[type] || type}\n`;
            copyText += `Îì±Ïû•: ${casts.length ? casts.join(', ') : 'ÏóÜÏùå'}\n`;
            if (source) copyText += `Ï∂úÏ≤ò: ${source}\n`;
            copyText += `\n${'='.repeat(40)}\n\n`;
            
            let branches = []; // Î∂ÑÍ∏∞ Ï†ÄÏû•Ïö©
            
            function getBranchDialogues(startFrame, allBranchStarts) {
                const dialogues = [];
                let current = startFrame;
                const visited = new Set();
                
                while (current != null && current !== -1) {
                    if (visited.has(current)) break;
                    visited.add(current);
                    if (current !== startFrame && allBranchStarts.has(current)) break;
                    
                    const frame = frames[String(current)];
                    if (!frame) break;
                    
                    let nextFrame = null;
                    for (const d of (frame.dialogue || [])) {
                        const speaker = d.speaker_name || '';
                        const text = (d.text || '').replace(/\\r/g, '\n');
                        nextFrame = d.next_frame;
                        
                        if (text) {
                            dialogues.push({ speaker, text });
                            skipFrames.add(current);
                        }
                    }
                    
                    let incomingCount = 0;
                    for (const fk in frames) {
                        for (const fd of (frames[fk].dialogue || [])) {
                            if (fd.next_frame === nextFrame) incomingCount++;
                        }
                    }
                    if (incomingCount > 1 && dialogues.length > 0) break;
                    
                    current = nextFrame;
                }
                return dialogues;
            }
            
            const sortedKeys = Object.keys(frames).sort((a, b) => parseInt(a) - parseInt(b));
            
            for (const frameKey of sortedKeys) {
                const frameNum = parseInt(frameKey);
                if (skipFrames.has(frameNum)) continue;
                
                const frame = frames[frameKey];
                for (const d of (frame.dialogue || [])) {
                    const speaker = d.speaker_name || '';
                    const text = (d.text || '').replace(/\\r/g, '<br>');
                    const textPlain = (d.text || '').replace(/\\r/g, '\n');
                    const choices = d.choices || [];
                    
                    if (!text && !choices.length) continue;
                    
                    html += '<div class="dialogue">';
                    
                    if (speaker) {
                        html += `<div class="speaker">„Äê${speaker}„Äë</div>`;
                    }
                    if (text) {
                        html += `<div class="text">${text}</div>`;
                        // Î≥µÏÇ¨Ïö© ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä
                        if (speaker) {
                            copyText += `[${speaker}] ${textPlain}\n`;
                        } else {
                            copyText += `${textPlain}\n`;
                        }
                    }
                    
                    if (choices.length) {
                        const flags = choices.map(c => c.flag_type || '');
                        const nextFrames = choices.map(c => c.next_frame).filter(f => f != null);
                        const nextSet = new Set(nextFrames);
                        
                        const isGenderOnly = flags.every(f => ['male_trainer', 'female_trainer', ''].includes(f)) && nextSet.size <= 1;
                        
                        html += '<div class="choices">';
                        html += `<div class="choices-title">‚ñº ÏÑ†ÌÉùÏßÄ${isGenderOnly ? '' : ' (Î∂ÑÍ∏∞)'}</div>`;
                        
                        const allBranchStarts = new Set(nextFrames);
                        
                        // Î≥µÏÇ¨Ïö©: ÏÑ†ÌÉùÏßÄ ÌëúÏãú
                        copyText += `\n`;
                        
                        for (let i = 0; i < choices.length; i++) {
                            const choice = choices[i];
                            const choiceText = choice.text || '';
                            const nextFrame = choice.next_frame;
                            const flag = choice.flag_type || '';
                            
                            if (!choiceText) continue;
                            
                            let label = '';
                            if (flag === 'male_trainer') label = '(ÎÇ®ÏÑ± Ìä∏Î†àÏù¥ÎÑà)';
                            else if (flag === 'female_trainer') label = '(Ïó¨ÏÑ± Ìä∏Î†àÏù¥ÎÑà)';
                            
                            html += '<div class="choice-block">';
                            html += `<div class="choice-text">${isGenderOnly ? '' : '‚û§ '}${choiceText}<span class="choice-label">${label}</span></div>`;
                            
                            // Î≥µÏÇ¨Ïö©: ÏÑ†ÌÉùÏßÄ Ï∂îÍ∞Ä
                            copyText += `[ÏÑ†ÌÉùÏßÄ ${i + 1}${label ? ' ' + label : ''}] ${choiceText}\n`;
                            
                            if (!isGenderOnly && nextFrame != null) {
                                const branchDialogues = getBranchDialogues(nextFrame, allBranchStarts);
                                
                                // Î∂ÑÍ∏∞ ÎÇ¥Ïö©Ïù¥ ÏûàÏúºÎ©¥ Ï†ÄÏû•
                                if (branchDialogues.length > 0) {
                                    let branchText = `\n${'_'.repeat(40)}\n\n`;
                                    branchText += `[ÏÑ†ÌÉùÏßÄ ${i + 1}Ïùò Î∂ÑÍ∏∞: ${choiceText}]\n\n`;
                                    
                                    for (const bd of branchDialogues) {
                                        html += '<div class="branch-dialogue">';
                                        if (bd.speaker) {
                                            html += `<div class="branch-speaker">„Äê${bd.speaker}„Äë</div>`;
                                            branchText += `[${bd.speaker}] ${bd.text}\n`;
                                        } else {
                                            branchText += `${bd.text}\n`;
                                        }
                                        html += `<div class="branch-text">${bd.text.replace(/\n/g, '<br>')}</div>`;
                                        html += '</div>';
                                    }
                                    
                                    branchText += `\n${'_'.repeat(40)}\n`;
                                    branches.push(branchText);
                                }
                            }
                            html += '</div>';
                        }
                        html += '</div>';
                        copyText += `\n`;
                    }
                    
                    html += '</div>';
                }
            }
            
            // Î∂ÑÍ∏∞ ÎÇ¥Ïö© Ï∂îÍ∞Ä
            if (branches.length > 0) {
                copyText += `\n${'='.repeat(40)}\n`;
                copyText += `[Î∂ÑÍ∏∞ ÎÇ¥Ïö©]\n`;
                for (const branch of branches) {
                    copyText += branch;
                }
            }
            
            // Î≥µÏÇ¨Ïö© ÌÖçÏä§Ìä∏ Ï†ÄÏû•
            storyTextData = copyText;
            
            document.getElementById('content').innerHTML = html;
        }
        
        function copyStoryText() {
            if (!storyTextData) {
                alert('Ïä§ÌÜ†Î¶¨Í∞Ä ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            navigator.clipboard.writeText(storyTextData).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '‚úì Î≥µÏÇ¨Îê®!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã Ï†ÑÏ≤¥ Î≥µÏÇ¨';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                // fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = storyTextData;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                const btn = document.querySelector('.copy-btn');
                btn.textContent = '‚úì Î≥µÏÇ¨Îê®!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'üìã Ï†ÑÏ≤¥ Î≥µÏÇ¨';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        init();
    </script>
</body>
</html>